version: '3'

vars:
  MODULE: github.com/shark-ci/shark-ci
  CI_SERVER_IMAGE: shark-ci/ci-server
  WORKER_IMAGE: shark-ci/worker
  DOCKER_REGISTRY: ghcr.io

dotenv: ['.env']

interval: '1s'

tasks:
  build:
    desc: Build CI server and worker
    aliases: ["b"]
    cmds:
      - task: build:ci-server
      - task: build:worker

  build:ci-server:
    desc: Build CI server
    aliases: ["b:ci-server"]
    cmds:
      - go build -o bin/ci-server {{.MODULE}}/cmd/ci-server
    sources:
      - cmd/ci-server/*.go
      - ci-server/**/*.go
      - shared/**/*.go
    generates:
      - bin/ci-server
    method: timestamp

  build:worker:
    aliases: ["b:worker"]
    desc: Build worker
    cmds:
      - go build -o bin/worker {{.MODULE}}/cmd/worker
    sources:
      - cmd/worker/*.go
      - worker/**/*.go
      - shared/**/*.go
    generates:
      - bin/worker
    method: timestamp

  run:
    desc: Run CI server and worker
    aliases: ["r"]
    deps:
      - run:ci-server
      - run:worker

  run:ci-server:
    desc: Run CI server
    aliases: ["r:ci-server"]
    deps:
      - build:ci-server
    cmds:
      - bin/ci-server

  run:worker:
    desc: Run worker
    aliases: ["r:worker"]
    deps:
      - build:worker
    cmds:
      - bin/worker

  clean:
    desc: Clean build artifacts
    aliases: ["c"]
    cmds:
      - go clean
      - rm -rf bin
      - rm -rf .task/timestamp

  test:
    desc: Run tests
    aliases: ["t"]
    cmds:
      - go test -v ./...

  ngrok:
    desc: Startup Ngrok
    cmds:
      - ngrok http --domain {{.NGROK_DOMAIN}} 8000

  docker:up:
    desc: Start docker containers
    cmds:
      - docker compose up

  docker:dev:up:
    desc: Start docker containers for development
    aliases: ["d:dev:up"]
    cmds:
      - docker compose -f docker-compose.dev.yaml up

  docker:build:
    desc: Build docker images
    aliases: ["d:b"]
    deps:
      - docker:build:ci-server
      - docker:build:worker

  docker:build:ci-server:
    desc: Build CI server docker image
    aliases: ["d:b:ci-server"]
    cmds:
      - docker build --pull -f Dockerfile.ci-server -t {{.CI_SERVER_IMAGE}} .

  docker:build:worker:
    desc: Build worker docker image
    aliases: ["d:b:worker"]
    cmds:
      - docker build --pull -f Dockerfile.worker -t {{.WORKER_IMAGE}} .

  docker:tag:
    desc: Tag images
    vars:
      TAG: '{{default "latest" .TAG}}'
    cmds:
      - task: docker:tag:ci-server
        vars:
          TAG: "{{.TAG}}"
      - task: docker:tag:worker
        vars:
          TAG: "{{.TAG}}"

  docker:tag:ci-server:
    desc: Tag CI server docker image
    vars:
      TAG: '{{default "latest" .TAG}}'
    cmds:
      - docker tag {{.CI_SERVER_IMAGE}}:latest {{.CI_SERVER_IMAGE}}:{{.TAG}}
      - docker tag {{.CI_SERVER_IMAGE}}:latest {{.DOCKER_REGISTRY}}/{{.CI_SERVER_IMAGE}}:{{.TAG}}

  docker:tag:worker:
    desc: Tag worker docker image
    vars:
      TAG: '{{default "latest" .TAG}}'
    cmds:
      - docker tag {{.WORKER_IMAGE}}:latest {{.WORKER_IMAGE}}:{{.TAG}}
      - docker tag {{.WORKER_IMAGE}}:latest {{.DOCKER_REGISTRY}}/{{.WORKER_IMAGE}}:{{.TAG}}

  docker:push:
    desc: Push images to container registry
    vars:
      TAG: '{{default "latest" .TAG}}'
    cmds:
      - task: docker:push:ci-server
        vars:
          TAG: "{{.TAG}}"
      - task: docker:push:worker
        vars:
          TAG: "{{.TAG}}"

  docker:push:ci-server:
    desc: Push CI server to container registry
    vars:
      TAG: '{{default "latest" .TAG}}'
    cmds:
      - docker push {{.DOCKER_REGISTRY}}/{{.CI_SERVER_IMAGE}}:{{.TAG}}

  docker:push:worker:
    desc: Push worker to container registry
    vars:
      TAG: '{{default "latest" .TAG}}'
    cmds:
      - docker push {{.DOCKER_REGISTRY}}/{{.WORKER_IMAGE}}:{{.TAG}}

  migrate:create:
    desc: Create new migration file
    cmds:
      - migrate create -ext sql -dir migrations -format 20060102150405 {{.CLI_ARGS}}

  migrate:up:
    desc: Run migrations up
    cmds:
      - migrate -path migrations -database ${DB_URI} -verbose up

  migrate:down:
    desc: Run migrations down
    cmds:
      - migrate -path migrations -database ${DB_URI} -verbose down

  release:
    desc: Create new release
    prompt: Do you want to create a new release?
    deps:
      - docker:build
    cmds:
      - git tag -s v{{.VERSION}} -m "Release v{{.VERSION}}"
      - git push origin v{{.VERSION}}
      - task: docker:tag
      - task: docker:tag
        vars:
          TAG: "{{.VERSION}}"
      - task: docker:push
      - task: docker:push
        vars:
          TAG: "{{.VERSION}}"
    requires:
      vars: ["VERSION"]

  grpc:generate:
    desc: Generate gRPC code
    cmds:
      - >
        protoc --go_out=. --go_opt=paths=source_relative
        --go-grpc_out=. --go-grpc_opt=paths=source_relative
        shared/proto/pipeline_reporter.proto
